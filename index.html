<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>È∫ªÈõÄ„Çπ„Ç≥„Ç¢</title>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<style>
:root {
  --green-dark:#0b3b2e;
  --green-main:#145a43;
  --green-soft:#e6f2ee;
  --gold:#c9a24d;
  --bg:#f4f7f6;
  --panel:#ffffff;
  --text:#222;
}
body.dark {
  --bg:#0f1f1b;
  --panel:#162a25;
  --text:#e5ece9;
}

body {
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui;
}

/* ===== „Éò„ÉÉ„ÉÄ„Éº ===== */
header {
  background:linear-gradient(135deg,var(--green-dark),var(--green-main));
  color:#fff;
  padding:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* ===== „ÉÜ„Éº„Éñ„É´ ===== */
main { padding:12px; padding-bottom:280px; }

.input-table {
  width:100%;
  border-collapse:collapse;
  background:var(--panel);
  border-radius:14px;
  overflow:hidden;
}
.input-table th {
  background:var(--green-soft);
  padding:8px;
}
.input-table td {
  padding:8px;
  text-align:center;
  border-top:1px solid #ddd;
}
.input-table tr.active { background:#d7ebe4; }

.score {
  width:72px;
  font-size:20px;
  text-align:right;
  border-radius:8px;
  border:1px solid #aaa;
}

.tobi {
  width:54px;
  border-radius:20px;
  border:none;
  font-weight:700;
}
.tobi.plus { background:#c9f2d8; }
.tobi.minus { background:#f6caca; }

.final.plus { color:#1e8e3e; }
.final.minus { color:#c62828; }

/* ===== „Éú„Çø„É≥ ===== */
.actions {
  margin-top:12px;
  display:flex;
  gap:10px;
}
.actions button {
  flex:1;
  border:none;
  border-radius:30px;
  padding:12px;
  font-size:16px;
}
#calc { background:var(--green-main); color:#fff; }
#reg  { background:var(--gold); }
#show { background:#e0e6e3; }

/* ===== Â±•Ê≠¥ ===== */
.score-table {
  margin-top:14px;
  width:100%;
  border-collapse:collapse;
  background:#fff;
}
.score-table th, .score-table td {
  border:1px solid #c9d7e3;
  padding:6px;
  text-align:center;
}
.score-table tr.invalid {
  text-decoration:line-through;
  color:#999;
}

/* ===== ÈõªÂçì ===== */
.keypad {
  position:fixed;
  bottom:0;
  right:0;
  width:70%;
  max-width:420px;
  background:var(--panel);
  border-top-left-radius:20px;
  padding:12px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  grid-template-areas:
    "up down minus clear"
    "n7 n8 n9 close"
    "n4 n5 n6 close"
    "n1 n2 n3 close"
    ".  n0 n0 close";
  gap:10px;
}
.keypad button {
  font-size:22px;
  padding:16px;
  border:none;
  border-radius:14px;
}

[data-k="close"] { grid-area:close; background:#ddd; }

.keypad.hidden { display:none; }

/* ===== ÈõªÂçìÂæ©Â∏∞„Éú„Çø„É≥ ===== */
#showKeypad {
  position:fixed;
  right:12px;
  bottom:12px;
  border:none;
  border-radius:50%;
  width:56px;
  height:56px;
  font-size:20px;
  background:var(--green-main);
  color:#fff;
  display:none;
}

/* ===== „É≠„Éº„Éá„Ç£„É≥„Ç∞ ===== */
#loading {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.4);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}
#loading div {
  width:48px;
  height:48px;
  border:6px solid #fff;
  border-top-color:transparent;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin { to { transform:rotate(360deg); } }
</style>
</head>

<body>

<header>
  <div>üÄÑ MAHJONG SCORE</div>
  <button id="mode">Dark</button>
</header>

<main>
<table class="input-table">
<tr><th>ÂêçÂâç</th><th>„Çπ„Ç≥„Ç¢</th><th>„Éà„Éì</th><th>ÊúÄÁµÇ</th></tr>
<tr data-idx="0" class="active"><td>A</td><td><input class="score" readonly></td><td><button class="tobi"></button></td><td class="final"></td></tr>
<tr data-idx="1"><td>B</td><td><input class="score" readonly></td><td><button class="tobi"></button></td><td class="final"></td></tr>
<tr data-idx="2"><td>C</td><td><input class="score" readonly></td><td><button class="tobi"></button></td><td class="final"></td></tr>
<tr data-idx="3"><td>D</td><td><input class="score" readonly></td><td><button class="tobi"></button></td><td class="final"></td></tr>
</table>

<div class="actions">
  <button id="calc">Ë®àÁÆó</button>
  <button id="reg" disabled>ÁôªÈå≤</button>
  <button id="show">Â±•Ê≠¥</button>
</div>

<div id="scoreArea"></div>
</main>

<div class="keypad">
<button data-k="up">‚Üë</button>
<button data-k="down">‚Üì</button>
<button data-k="-">‚àí</button>
<button data-k="clear">C</button>

<button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button><button data-k="close">√ó</button>
<button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button>
<button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button>
<button data-k="0">0</button>
</div>

<button id="showKeypad">Èõª</button>

<div id="loading"><div></div></div>

<script>
const GAS_URL='https://script.google.com/macros/s/AKfycby1XFM-wXWJKnuSnLXpuUGhT6dE-bmrgFwVI_V5XVzLlHTnsFr0TiVRGRfNlqK38z_a/exec';
let cur=0,fresh=[1,1,1,1],lastScore=null;

function focus(i){
  cur=Math.max(0,Math.min(3,i));
  fresh[cur]=1;
  $('tr').removeClass('active');
  $(`tr[data-idx="${cur}"]`).addClass('active');
}

$('.keypad button').on('click',function(){
  const k=$(this).data('k');
  const inp=$('.score').eq(cur);
  if(k==='up')return focus(cur-1);
  if(k==='down')return focus(cur+1);
  if(k==='clear'){inp.val('');fresh[cur]=1;return;}
  if(k==='close'){ $('.keypad').addClass('hidden'); $('#showKeypad').show(); return;}
  if(fresh[cur]){inp.val('');fresh[cur]=0;}
  inp.val((inp.val()||'')+k);
});

$('#showKeypad').on('click',()=>{
  $('.keypad').removeClass('hidden');
  $('#showKeypad').hide();
});

/* „Éà„ÉìÁã¨Á´ã„Éà„Ç∞„É´ */
$('.tobi').on('click',function(){
  const t=$(this).text();
  $(this).removeClass('plus minus').text('');
  if(t==='')$(this).text('+10').addClass('plus');
  else if(t==='+10')$(this).text('-10').addClass('minus');
});

/* Ë®àÁÆó */
$('#calc').on('click',()=>{
  let raw=$('.score').map((i,e)=>{
    const v=$(e).val();
    return v===''?null:Number(v);
  }).get();

  const empty=raw.filter(v=>v===null).length;
  if(empty>1){alert('Êú™ÂÖ•Âäõ„ÅØ1‰∫∫„Åæ„Åß„Åß„Åô');return;}

  if(empty===1){
    const sum3=raw.filter(v=>v!==null).reduce((a,b)=>a+b,0);
    raw[raw.indexOf(null)]=1000-sum3;
    $('.score').eq(raw.indexOf(null)).val(1000-sum3);
  }

  if(raw.reduce((a,b)=>a+b,0)!==1000){
    alert('ÂêàË®à„ÅØ1000„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ');return;
  }

  const idx=[0,1,2,3].sort((a,b)=>raw[b]-raw[a]);
  const uma=[500,100,-100,-300];
  let sc=raw.map((v,i)=>Math.round((v+uma[idx.indexOf(i)]-300)/10));
  sc[idx[0]]-=sc.reduce((a,b)=>a+b,0);

  $('.tobi').each((i,e)=>{
    if($(e).text()==='+10')sc[i]+=10;
    if($(e).text()==='-10')sc[i]-=10;
  });

  lastScore=sc;
  $('.final').each((i,e)=>{
    $(e).text(sc[i]).removeClass('plus minus')
      .addClass(sc[i]>=0?'plus':'minus');
  });
  $('#reg').prop('disabled',false);
});

/* ÁôªÈå≤ */
$('#reg').on('click',()=>{
  if(!confirm('ÁôªÈå≤„Åó„Åæ„Åô„ÅãÔºü'))return;
  $('#loading').show();
  fetch(GAS_URL,{method:'POST',body:JSON.stringify({score:lastScore})})
    .then(()=>{alert('ÁôªÈå≤„Åó„Åæ„Åó„Åü');location.reload();});
});

/* Â±•Ê≠¥ */
$('#show').on('click',()=>{
  $('#loading').show();
  fetch(GAS_URL).then(r=>r.json()).then(data=>{
    $('#loading').hide();
    let h='<table class="score-table"><tr><th>Êó•ÊôÇ</th><th>A</th><th>B</th><th>C</th><th>D</th></tr>';
    data.forEach(d=>{
      h+=`<tr class="${d.valid?'':'invalid'}" data-row="${d.row}">
        <td>${new Date(d.time).toLocaleString()}</td>
        ${d.score.map(s=>`<td>${s}</td>`).join('')}
      </tr>`;
    });
    h+='</table>';
    $('#scoreArea').html(h);
  });
});
</script>

</body>
</html>
