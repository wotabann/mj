<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>éº»é›€ã‚¹ã‚³ã‚¢</title>
<script src="https://code.jquery.com/jquery.com/jquery-3.7.1.min.js"></script>

<style>
/* --- çœç•¥ã›ãšå…¨éƒ¨æ›¸ã„ã¦ã¾ã™ãŒã€å‰å›ã¨åŒã˜é…è‰² --- */
:root{
  --dark:#0b3b2e; --main:#145a43; --soft:#e9f3ef;
  --gold:#c9a24d; --bg:#f4f7f6; --panel:#fff; --txt:#222;
}
body{margin:0;background:var(--bg);font-family:system-ui;color:var(--txt);}
header{background:linear-gradient(135deg,var(--dark),var(--main));color:#fff;padding:12px;}
main{padding:12px;padding-bottom:340px;}

table{width:100%;background:#fff;border-radius:14px;border-collapse:collapse;}
th,td{padding:8px;text-align:center;}
th{background:var(--soft);}
tr+tr td{border-top:1px solid #ddd;}
tr.active{background:#d7ebe4;}

.score{width:80px;font-size:20px;text-align:right;}
.tobi{width:56px;border-radius:20px;border:none;}
.tobi.plus{background:#c9f2d8;}
.tobi.minus{background:#f6caca;}

.final.plus{color:#1e8e3e;}
.final.minus{color:#c62828;}

.actions{margin-top:12px;display:flex;gap:10px;}
.actions button{flex:1;padding:12px;border:none;border-radius:30px;font-size:16px;}
#calc{background:var(--main);color:#fff;}
#reg{background:var(--gold);}
#show{background:#e0e6e3;}

.keypad{
  position:fixed;right:0;bottom:0;width:70%;max-width:420px;
  background:#fff;padding:12px;border-top-left-radius:20px;
  display:grid;grid-template-columns:repeat(4,1fr);gap:10px;
}
.keypad.hidden{display:none;}
.keypad button{padding:16px;font-size:22px;border-radius:14px;border:none;}

#toggleKeypad{
  position:fixed;right:14px;bottom:14px;
  width:56px;height:56px;border-radius:50%;
  background:var(--main);color:#fff;border:none;font-size:20px;
}

#loading{
  position:fixed;inset:0;background:rgba(0,0,0,.4);
  display:none;justify-content:center;align-items:center;
}
#loading div{
  width:48px;height:48px;border:6px solid #fff;
  border-top-color:transparent;border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg);}}

#history{margin-top:16px;}
#history table{font-size:14px;}
.invalid{text-decoration:line-through;color:#999;}
</style>
</head>

<body>
<header>ğŸ€„ MAHJONG SCORE</header>

<main>
<table id="inputTable">
<tr><th>åå‰</th><th>ã‚¹ã‚³ã‚¢</th><th>ãƒˆãƒ“</th><th>æœ€çµ‚</th></tr>
<tr data-i="0" class="active"><td>A</td><td><input class="score" readonly></td><td><button class="tobi"></button></td><td class="final"></td></tr>
<tr data-i="1"><td>B</td><td><input class="score" readonly></td><td><button class="tobi"></button></td><td class="final"></td></tr>
<tr data-i="2"><td>C</td><td><input class="score" readonly></td><td><button class="tobi"></button></td><td class="final"></td></tr>
<tr data-i="3"><td>D</td><td><input class="score" readonly></td><td><button class="tobi"></button></td><td class="final"></td></tr>
</table>

<div class="actions">
  <button id="calc">è¨ˆç®—</button>
  <button id="reg">ç™»éŒ²</button>
  <button id="show">å±¥æ­´</button>
</div>

<div id="history"></div>
</main>

<!-- é›»å“ -->
<div class="keypad" id="keypad">
  <button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button><button data-k="up">â†‘</button>
  <button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button><button data-k="down">â†“</button>
  <button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button><button data-k="pm">Â±</button>
  <button data-k="clear">C</button><button data-k="0">0</button><button data-k="fill">è£œ</button>
</div>

<button id="toggleKeypad">Ã—</button>
<div id="loading"><div></div></div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycby1XFM-wXWJKnuSnLXpuUGhT6dE-bmrgFwVI_V5XVzLlHTnsFr0TiVRGRfNlqK38z_a/exec';

let active=0;
let fresh=[true,true,true,true];
let lastResult=null;

/* ---------------- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ ---------------- */
function focusRow(i){
  active=Math.max(0,Math.min(3,i));
  $('tr').removeClass('active');
  $(`tr[data-i="${active}"]`).addClass('active');
  fresh[active]=true;
}

$('.score').on('click',function(){
  focusRow($(this).closest('tr').data('i'));
});

/* ---------------- é›»å“åˆ‡æ›¿ ---------------- */
$('#toggleKeypad').on('click',()=>{
  $('#keypad').toggleClass('hidden');
  $('#toggleKeypad').text($('#keypad').hasClass('hidden')?'é›»':'Ã—');
});

/* ---------------- é›»å“å…¥åŠ› ---------------- */
$('.keypad button').on('click',function(){
  const k=$(this).data('k');
  const input=$('.score').eq(active);

  if(['0','1','2','3','4','5','6','7','8','9','pm'].includes(k)){
    if(fresh[active]){
      input.val('');
      fresh[active]=false;
    }
  }

  if(k==='up') return focusRow(active-1);
  if(k==='down') return focusRow(active+1);
  if(k==='clear'){input.val('');fresh[active]=true;return;}

  if(k==='pm'){
    const v=input.val();
    if(!v)return;
    input.val(v.startsWith('-')?v.slice(1):'-'+v);
    return;
  }

  if(k==='fill'){
    const vals=$('.score').map((i,e)=>$(e).val().trim()).get();
    const empties=vals.map((v,i)=>v===''?i:null).filter(v=>v!==null);
    if(empties.length!==1){
      alert('ç©ºæ¬„ãŒ1äººã®ã¨ãã®ã¿è£œå®Œã§ãã¾ã™');
      return;
    }
    const sum=vals.reduce((a,b)=>a+(b===''?0:Number(b)),0);
    const idx=empties[0];
    $('.score').eq(idx).val(1000-sum);
    fresh[idx]=false;
    return;
  }

  if(/^\d$/.test(k)){
    input.val((input.val()||'')+k);
  }
});

/* ---------------- ãƒˆãƒ“ ---------------- */
$('.tobi').on('click',function(){
  if($(this).text()===''){ $(this).text('+10').addClass('plus'); return; }
  if($(this).text()==='+10'){ $(this).text('-10').removeClass('plus').addClass('minus'); return; }
  $(this).text('').removeClass('minus');
});

/* ---------------- å…¥åŠ›æ¤œè¨¼ ---------------- */
function validateInput(){
  const raw=$('.score').map((i,e)=>$(e).val().trim()).get();
  if(raw.includes('')){ alert('æœªå…¥åŠ›ãŒã‚ã‚Šã¾ã™'); return null; }

  const nums=raw.map(Number);
  if(nums.reduce((a,b)=>a+b,0)!==1000){
    alert('åˆè¨ˆã¯1000ã«ã—ã¦ãã ã•ã„'); return null;
  }

  const plus=$('.tobi').filter((i,e)=>$(e).text()==='+10').length;
  const minus=$('.tobi').filter((i,e)=>$(e).text()==='-10').length;
  if(!((plus===0&&minus===0)||(plus===1&&minus===1))){
    alert('ãƒˆãƒ“è¨­å®šãŒä¸æ­£ã§ã™'); return null;
  }
  return nums;
}

/* ---------------- è¨ˆç®— ---------------- */
function calculate(nums){
  const order=[0,1,2,3].sort((a,b)=>nums[b]-nums[a]);
  const uma=[500,100,-100,-300];
  let sc=nums.map((v,i)=>Math.round((v+uma[order.indexOf(i)]-300)/10));
  sc[order[0]]-=sc.reduce((a,b)=>a+b,0);

  $('.tobi').each((i,e)=>{
    if($(e).text()==='+10') sc[i]+=10;
    if($(e).text()==='-10') sc[i]-=10;
  });
  return sc;
}

$('#calc').on('click',()=>{
  const nums=validateInput();
  if(!nums)return;
  const sc=calculate(nums);
  lastResult=sc;
  $('.final').each((i,e)=>{
    $(e).text(sc[i]).removeClass('plus minus')
      .addClass(sc[i]>=0?'plus':'minus');
  });
});

/* ---------------- ç™»éŒ² ---------------- */
$('#reg').on('click',()=>{
  if(!lastResult){ alert('å…ˆã«è¨ˆç®—ã—ã¦ãã ã•ã„'); return; }
  if(!confirm('ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ')) return;

  $('#loading').show();
  $.ajax({
    url:GAS_URL,
    method:'POST',
    contentType:'application/json',
    data:JSON.stringify({action:'register',score:lastResult})
  }).done(res=>{
    alert('ç™»éŒ²ã—ã¾ã—ãŸ');
    $('#show').click();
  }).fail(()=>{
    alert('é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }).always(()=>$('#loading').hide());
});

/* ---------------- å±¥æ­´ ---------------- */
$('#show').on('click',()=>{
  $('#loading').show();
  $.getJSON(GAS_URL+'?action=list')
  .done(res=>{
    let html='<table><tr><th>No</th><th>æ—¥æ™‚</th><th>A</th><th>B</th><th>C</th><th>D</th><th>åˆè¨ˆ</th></tr>';
    res.forEach(r=>{
      const cls=r.invalid?'invalid':'';
      html+=`<tr class="${cls}">
        <td>${r.no}</td><td>${r.date}</td>
        <td>${r.a}</td><td>${r.b}</td><td>${r.c}</td><td>${r.d}</td>
        <td>${r.sum}</td></tr>`;
    });
    html+='</table>';
    $('#history').html(html);
  })
  .fail(()=>alert('é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ'))
  .always(()=>$('#loading').hide());
});
</script>
</body>
</html>
