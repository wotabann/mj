<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>È∫ªÈõÄ„Çπ„Ç≥„Ç¢</title>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<style>
/* ===== THEME ===== */
:root{
  --dark:#0b3b2e;
  --main:#145a43;
  --soft:#e9f3ef;
  --gold:#c9a24d;
  --bg:#f4f7f6;
  --panel:#ffffff;
  --txt:#222;
}
body.dark{
  --bg:#0f1f1b;
  --panel:#162a25;
  --txt:#e6ecea;
}

body{
  margin:0;
  background:var(--bg);
  color:var(--txt);
  font-family:system-ui;
}

/* ===== HEADER ===== */
header{
  background:linear-gradient(135deg,var(--dark),var(--main));
  color:#fff;
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header button{
  background:none;
  border:1px solid #fff;
  color:#fff;
  border-radius:20px;
  padding:4px 10px;
}

/* ===== MAIN ===== */
main{
  padding:12px;
  padding-bottom:320px;
}

table{
  width:100%;
  border-collapse:collapse;
  background:var(--panel);
  border-radius:14px;
  overflow:hidden;
}
th{
  background:var(--soft);
  padding:8px;
}
td{
  padding:8px;
  text-align:center;
  border-top:1px solid #ddd;
}
tr.active{
  background:#d7ebe4;
}

.score{
  width:80px;
  font-size:20px;
  text-align:right;
  border-radius:8px;
  border:1px solid #aaa;
}

.tobi{
  width:56px;
  border-radius:20px;
  border:none;
  font-weight:bold;
}
.tobi.plus{background:#c9f2d8;}
.tobi.minus{background:#f6caca;}

.final.plus{color:#1e8e3e;}
.final.minus{color:#c62828;}

.actions{
  margin-top:12px;
  display:flex;
  gap:10px;
}
.actions button{
  flex:1;
  padding:12px;
  border:none;
  border-radius:30px;
  font-size:16px;
}
#calc{background:var(--main);color:#fff;}
#reg{background:var(--gold);}
#show{background:#e0e6e3;}

/* ===== KEYPAD ===== */
.keypad{
  position:fixed;
  right:0;
  bottom:0;
  width:70%;
  max-width:420px;
  background:var(--panel);
  padding:12px;
  border-top-left-radius:20px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
}
.keypad button{
  font-size:22px;
  padding:16px;
  border:none;
  border-radius:14px;
}
.keypad.hidden{display:none;}

#showKeypad{
  position:fixed;
  right:14px;
  bottom:14px;
  width:56px;
  height:56px;
  border-radius:50%;
  background:var(--main);
  color:#fff;
  border:none;
  font-size:18px;
}

/* ===== LOADING ===== */
#loading{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}
#loading div{
  width:48px;height:48px;
  border:6px solid #fff;
  border-top-color:transparent;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>

<body>

<header>
  <div>üÄÑ MAHJONG SCORE</div>
  <button id="mode">Dark</button>
</header>

<main>
<table>
<tr><th>ÂêçÂâç</th><th>„Çπ„Ç≥„Ç¢</th><th>„Éà„Éì</th><th>ÊúÄÁµÇ</th></tr>
<tr data-i="0" class="active"><td>A</td><td><input class="score" readonly></td><td><button class="tobi"></button></td><td class="final"></td></tr>
<tr data-i="1"><td>B</td><td><input class="score" readonly></td><td><button class="tobi"></button></td><td class="final"></td></tr>
<tr data-i="2"><td>C</td><td><input class="score" readonly></td><td><button class="tobi"></button></td><td class="final"></td></tr>
<tr data-i="3"><td>D</td><td><input class="score" readonly></td><td><button class="tobi"></button></td><td class="final"></td></tr>
</table>

<div class="actions">
  <button id="calc">Ë®àÁÆó</button>
  <button id="reg" disabled>ÁôªÈå≤</button>
  <button id="show">Â±•Ê≠¥</button>
</div>

<div id="history"></div>
</main>

<!-- ===== KEYPAD ===== -->
<div class="keypad">
  <button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button><button data-k="up">‚Üë</button>
  <button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button><button data-k="down">‚Üì</button>
  <button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button><button data-k="pm">¬±</button>
  <button data-k="clear">C</button><button data-k="0">0</button><button data-k="close">√ó</button>
</div>

<button id="showKeypad">Èõª</button>
<div id="loading"><div></div></div>

<script>
const GAS_URL = 'ÔºúGAS„ÅÆURLÔºû';

let activeIndex = 0;
let isFresh = [true,true,true,true];
let lastScore = null;

/* ===== MODE ===== */
$('#mode').on('click',()=>{
  $('body').toggleClass('dark');
});

/* ===== FOCUS ===== */
function focusRow(i){
  activeIndex = Math.max(0,Math.min(3,i));
  $('tr').removeClass('active');
  $(`tr[data-i="${activeIndex}"]`).addClass('active');
  isFresh[activeIndex] = true;
}

$('.score').on('click',function(){
  focusRow($(this).closest('tr').data('i'));
});

/* ===== KEYPAD ===== */
$('.keypad button').on('click',function(){
  const k = $(this).data('k');
  const input = $('.score').eq(activeIndex);

  if(['0','1','2','3','4','5','6','7','8','9','pm'].includes(k)){
    if(isFresh[activeIndex]){
      input.val('');
      isFresh[activeIndex] = false;
    }
  }

  if(k==='up') return focusRow(activeIndex-1);
  if(k==='down') return focusRow(activeIndex+1);
  if(k==='clear'){ input.val(''); isFresh[activeIndex]=true; return; }
  if(k==='pm'){
    const v = input.val();
    if(!v) return;
    input.val(v.startsWith('-') ? v.slice(1) : '-'+v);
    return;
  }
  if(k==='close'){
    $('.keypad').addClass('hidden');
    $('#showKeypad').show();
    return;
  }

  input.val((input.val()||'') + k);
});

$('#showKeypad').on('click',()=>{
  $('.keypad').removeClass('hidden');
  $('#showKeypad').hide();
});

/* ===== TOBI ===== */
$('.tobi').on('click',function(){
  if($(this).text()===''){ $(this).text('+10').addClass('plus'); return; }
  if($(this).text()==='+10'){ $(this).text('-10').removeClass('plus').addClass('minus'); return; }
  $(this).text('').removeClass('minus');
});

/* ===== CALC ===== */
$('#calc').on('click',()=>{
  let raw = $('.score').map((i,e)=>{
    const v=$(e).val();
    return v==='' ? null : Number(v);
  }).get();

  const emptyIdx = raw.map((v,i)=>v===null?i:null).filter(v=>v!==null);
  if(emptyIdx.length>1){
    alert('Êú™ÂÖ•Âäõ„ÅØ1‰∫∫„Åæ„Åß„Åß„Åô');
    return;
  }

  if(emptyIdx.length===1){
    const idx = emptyIdx[0];
    const sum3 = raw.reduce((a,b)=>a+(b??0),0);
    raw[idx] = 1000 - sum3;
    $('.score').eq(idx).val(raw[idx]);
  }

  const total = raw.reduce((a,b)=>a+b,0);
  if(total!==1000){
    alert('ÂêàË®à„ÅØ1000„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }

  const plus=$('.tobi').filter((i,e)=>$(e).text()==='+10').length;
  const minus=$('.tobi').filter((i,e)=>$(e).text()==='-10').length;
  if(!((plus===0&&minus===0)||(plus===1&&minus===1))){
    alert('„Éà„ÉìË®≠ÂÆö„Åå‰∏çÊ≠£„Åß„Åô');
    return;
  }

  const order=[0,1,2,3].sort((a,b)=>raw[b]-raw[a]);
  const uma=[500,100,-100,-300];
  let sc=raw.map((v,i)=>Math.round((v+uma[order.indexOf(i)]-300)/10));
  sc[order[0]]-=sc.reduce((a,b)=>a+b,0);

  $('.tobi').each((i,e)=>{
    if($(e).text()==='+10') sc[i]+=10;
    if($(e).text()==='-10') sc[i]-=10;
  });

  lastScore=sc;
  $('.final').each((i,e)=>{
    $(e).text(sc[i]).removeClass('plus minus')
      .addClass(sc[i]>=0?'plus':'minus');
  });
  $('#reg').prop('disabled',false);
});
</script>

</body>
</html>
