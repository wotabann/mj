<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>éº»é›€ã‚¹ã‚³ã‚¢</title>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<style>
/* ===============================
   ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆï¼ˆMãƒªãƒ¼ã‚°æ„è­˜ï¼‰
================================ */
:root {
  --green-dark:#0b3b2e;
  --green-main:#145a43;
  --green-soft:#e6f2ee;
  --gold:#c9a24d;

  --bg:#f4f7f6;
  --panel:#ffffff;
  --text:#222;
  --muted:#666;
}

body.dark {
  --bg:#0f1f1b;
  --panel:#162a25;
  --text:#e5ece9;
  --muted:#aabdb6;
}

/* ===============================
   ãƒ™ãƒ¼ã‚¹
================================ */
body {
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
}

header {
  background:linear-gradient(135deg,var(--green-dark),var(--green-main));
  color:#fff;
  padding:12px 14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

header .title {
  font-weight:700;
  letter-spacing:1px;
}

header button {
  background:rgba(255,255,255,0.15);
  color:#fff;
  border:none;
  border-radius:20px;
  padding:6px 12px;
}

/* ===============================
   ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
================================ */
main {
  padding:12px;
  padding-bottom:280px; /* ãƒ†ãƒ³ã‚­ãƒ¼åˆ† */
}

/* ===============================
   å…¥åŠ›ãƒ†ãƒ¼ãƒ–ãƒ«
================================ */
.input-table {
  width:100%;
  border-collapse:collapse;
  background:var(--panel);
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 6px 16px rgba(0,0,0,0.08);
}

.input-table th {
  background:var(--green-soft);
  color:var(--green-dark);
  padding:8px;
  font-size:13px;
}

.input-table td {
  padding:10px 6px;
  text-align:center;
  border-top:1px solid #dde5e2;
}

.input-table tr.active {
  background:#d7ebe4;
}

.score {
  width:72px;
  font-size:20px;
  text-align:right;
  background:#fff;
  border:1px solid #b5c7c0;
  border-radius:8px;
  padding:4px 6px;
}

.final.plus { color:#1e8e3e; font-weight:600; }
.final.minus { color:#c62828; font-weight:600; }

.tobi {
  width:54px;
  border-radius:20px;
  font-weight:700;
  border:none;
}
.tobi.plus { background:#c9f2d8; color:#0b3b2e; }
.tobi.minus { background:#f6caca; color:#6a0000; }

/* ===============================
   æ“ä½œãƒœã‚¿ãƒ³
================================ */
.actions {
  margin-top:14px;
  display:flex;
  gap:10px;
}

.actions button {
  flex:1;
  border:none;
  border-radius:30px;
  padding:12px;
  font-size:16px;
  font-weight:600;
}

#calc { background:var(--green-main); color:#fff; }
#reg  { background:var(--gold); color:#222; }
#show { background:#e0e6e3; }

/* ===============================
   ã‚¹ã‚³ã‚¢è¡¨ç¤º
================================ */
.score-table {
  margin-top:14px;
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:14px;
  overflow:hidden;
}

.score-table th,
.score-table td {
  border:1px solid #c9d7e3;
  padding:6px;
  text-align:center;
  font-size:13px;
  color:#222;
}

.score-table th {
  background:#f3f8fc;
}

.score-table tr.invalid {
  text-decoration:line-through;
  color:#999;
  background:#f5f5f5;
}

.score-table tr.total {
  font-weight:700;
  background:#eef6ff;
}

/* ===============================
   ãƒ†ãƒ³ã‚­ãƒ¼ï¼ˆå®Œå…¨é›»å“é…ç½®ï¼‰
================================ */
.keypad {
  position:fixed;
  bottom:0;
  right:0;
  width:70%;
  max-width:420px;
  background:var(--panel);
  border-top-left-radius:20px;
  box-shadow:-4px 0 16px rgba(0,0,0,0.2);
  padding:12px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  grid-template-areas:
    "up down minus clear"
    "n7 n8 n9 ."
    "n4 n5 n6 ."
    "n1 n2 n3 ."
    ".  n0 n0 .";
  gap:10px;
}

.keypad button {
  font-size:22px;
  padding:16px 0;
  border:none;
  border-radius:14px;
  background:#fff;
  box-shadow:0 3px 0 #aaa;
}

.keypad button:active {
  transform:translateY(2px);
  box-shadow:0 1px 0 #aaa;
}

[data-k="up"]    { grid-area:up; }
[data-k="down"]  { grid-area:down; }
[data-k="-"]     { grid-area:minus; }
[data-k="clear"] { grid-area:clear; background:#ffd6d6; }

[data-k="7"] { grid-area:n7; }
[data-k="8"] { grid-area:n8; }
[data-k="9"] { grid-area:n9; }
[data-k="4"] { grid-area:n4; }
[data-k="5"] { grid-area:n5; }
[data-k="6"] { grid-area:n6; }
[data-k="1"] { grid-area:n1; }
[data-k="2"] { grid-area:n2; }
[data-k="3"] { grid-area:n3; }
[data-k="0"] { grid-area:n0; }
</style>
</head>

<body>

<header>
  <div class="title">ğŸ€„ MAHJONG SCORE</div>
  <button id="mode">Dark</button>
</header>

<main>
<table class="input-table">
<tr><th>åå‰</th><th>ã‚¹ã‚³ã‚¢</th><th>ãƒˆãƒ“</th><th>æœ€çµ‚</th></tr>
<tr data-idx="0" class="active"><td>A</td><td><input class="score" readonly></td><td><button class="tobi"></button></td><td class="final"></td></tr>
<tr data-idx="1"><td>B</td><td><input class="score" readonly></td><td><button class="tobi"></button></td><td class="final"></td></tr>
<tr data-idx="2"><td>C</td><td><input class="score" readonly></td><td><button class="tobi"></button></td><td class="final"></td></tr>
<tr data-idx="3"><td>D</td><td><input class="score" readonly></td><td><button class="tobi"></button></td><td class="final"></td></tr>
</table>

<div class="actions">
  <button id="calc">è¨ˆç®—</button>
  <button id="reg" disabled>ç™»éŒ²</button>
  <button id="show">å±¥æ­´</button>
</div>

<div id="scoreArea"></div>
</main>

<div class="keypad">
<button data-k="up">â†‘</button>
<button data-k="down">â†“</button>
<button data-k="-">âˆ’</button>
<button data-k="clear">C</button>

<button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button>
<button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button>
<button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button>
<button data-k="0">0</button>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycby1XFM-wXWJKnuSnLXpuUGhT6dE-bmrgFwVI_V5XVzLlHTnsFr0TiVRGRfNlqK38z_a/exec';

let cur=0,fresh=[1,1,1,1],round=1,lastScore=null;

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
$('#mode').on('click',()=>{
  $('body').toggleClass('dark');
});

/* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ */
function focus(i){
  cur=Math.max(0,Math.min(3,i));
  fresh[cur]=1;
  $('tr[data-idx]').removeClass('active');
  $(`tr[data-idx="${cur}"]`).addClass('active');
}

/* ãƒ†ãƒ³ã‚­ãƒ¼ */
$('.keypad button').on('click',function(){
  const k=$(this).data('k');
  const inp=$('.score').eq(cur);
  if(k==='up')return focus(cur-1);
  if(k==='down')return focus(cur+1);
  if(k==='clear'){inp.val('');fresh[cur]=1;return;}
  if(fresh[cur]){inp.val('');fresh[cur]=0;}
  inp.val((inp.val()||'')+k);
});

/* ãƒˆãƒ“ */
$('.tobi').on('click',function(){
  const t=$(this).text();
  $('.tobi').text('').removeClass('plus minus');
  if(!t)$(this).text('+10').addClass('plus');
  else if(t==='+10')$(this).text('-10').addClass('minus');
});

/* è¨ˆç®— */
$('#calc').on('click',()=>{
  let raw=$('.score').map((i,e)=>{
    const v=$(e).val();
    return v===''?null:Number(v);
  }).get();

  const empty=raw.filter(v=>v===null).length;
  if(empty>1){alert('æœªå…¥åŠ›ã¯1äººã¾ã§ã§ã™');return;}

  if(empty===0){
    if(raw.reduce((a,b)=>a+b,0)!==1000){
      alert('åˆè¨ˆã¯1000ã«ã—ã¦ãã ã•ã„');return;
    }
  }

  if(empty===1){
    const sum3=raw.filter(v=>v!==null).reduce((a,b)=>a+b,0);
    const i=raw.indexOf(null);
    raw[i]=1000-sum3;
    $('.score').eq(i).val(raw[i]);
  }

  if(raw.reduce((a,b)=>a+b,0)!==1000){
    alert('åˆè¨ˆã¯1000ã«ã—ã¦ãã ã•ã„');return;
  }

  const idx=[0,1,2,3].sort((a,b)=>raw[b]-raw[a]);
  const uma=[500,100,-100,-300];
  let sc=raw.map((v,i)=>Math.round((v+uma[idx.indexOf(i)]-300)/10));
  sc[idx[0]]-=sc.reduce((a,b)=>a+b,0);

  $('.tobi').each((i,e)=>{
    if($(e).text()==='+10')sc[i]+=10;
    if($(e).text()==='-10')sc[i]-=10;
  });

  lastScore=sc;
  $('.final').each((i,e)=>{
    $(e).text(sc[i]).removeClass('plus minus')
      .addClass(sc[i]>=0?'plus':'minus');
  });

  $('#reg').prop('disabled',false);
});

/* ç™»éŒ² */
$('#reg').on('click',()=>{
  if(!confirm('ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ'))return;
  fetch(GAS_URL,{
    method:'POST',
    body:JSON.stringify({round,score:lastScore})
  }).then(()=>{
    alert('ç™»éŒ²ã—ã¾ã—ãŸ');
    location.reload();
  });
});

/* å±¥æ­´ */
$('#show').on('click',()=>{
  fetch(GAS_URL).then(r=>r.json()).then(data=>{
    let sum=[0,0,0,0];
    let h='<table class="score-table"><tr><th>æ—¥æ™‚</th><th>A</th><th>B</th><th>C</th><th>D</th></tr>';
    data.forEach(d=>{
      if(d.valid)d.score.forEach((v,i)=>sum[i]+=v);
      h+=`<tr class="${d.valid?'':'invalid'}" data-row="${d.row}">
        <td>${new Date(d.time).toLocaleString()}</td>
        ${d.score.map(s=>`<td>${s}</td>`).join('')}
      </tr>`;
    });
    h+=`<tr class="total"><td>åˆè¨ˆ</td>${sum.map(s=>`<td>${s}</td>`).join('')}</tr></table>`;
    $('#scoreArea').html(h);

    $('.score-table tr[data-row]').on('click',function(){
      if(confirm($(this).hasClass('invalid')?'æœ‰åŠ¹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ':'ç„¡åŠ¹ã«ã—ã¾ã™ã‹ï¼Ÿ')){
        fetch(GAS_URL+'?toggle='+$(this).data('row')).then(()=>$('#show').click());
      }
    });
  });
});
</script>

</body>
</html>
