<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>éº»é›€ã‚¹ã‚³ã‚¢</title>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<style>
/* ï¼ˆå‰å›ã¨åŒã˜ãƒ‡ã‚¶ã‚¤ãƒ³ãªã®ã§çœç•¥ã›ãšç¶­æŒï¼‰ */
:root{
  --g-dark:#0b3b2e;
  --g-main:#145a43;
  --g-soft:#e6f2ee;
  --gold:#c9a24d;
  --bg:#f4f7f6;
  --panel:#fff;
  --txt:#222;
}
body{
  margin:0;
  background:var(--bg);
  color:var(--txt);
  font-family:system-ui;
}
header{
  background:linear-gradient(135deg,var(--g-dark),var(--g-main));
  color:#fff;
  padding:12px;
}
main{padding:12px;padding-bottom:320px;}

table{
  width:100%;
  border-collapse:collapse;
  background:var(--panel);
  border-radius:14px;
}
th{background:var(--g-soft);padding:8px;}
td{padding:8px;text-align:center;border-top:1px solid #ddd;}
tr.active{background:#d7ebe4;}

.score{
  width:72px;
  font-size:20px;
  text-align:right;
}

.tobi{
  width:54px;
  border-radius:20px;
  border:none;
  font-weight:bold;
}
.tobi.plus{background:#c9f2d8;}
.tobi.minus{background:#f6caca;}

.final.plus{color:#1e8e3e;}
.final.minus{color:#c62828;}

.actions{
  margin-top:12px;
  display:flex;
  gap:10px;
}
.actions button{
  flex:1;
  padding:12px;
  border:none;
  border-radius:30px;
}

.keypad{
  position:fixed;
  right:0;bottom:0;
  width:70%;
  background:#fff;
  padding:12px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
}

.keypad button{
  font-size:22px;
  padding:16px;
  border:none;
  border-radius:14px;
}

.keypad.hidden{display:none;}

#loading{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}
#loading div{
  width:48px;height:48px;
  border:6px solid #fff;
  border-top-color:transparent;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg);}}

/* å±¥æ­´ */
.score-table{
  margin-top:16px;
  width:100%;
  border-collapse:collapse;
  background:#fff;
}
.score-table th,.score-table td{
  border:1px solid #c9d7e3;
  padding:6px;
}
.score-table tr.invalid{
  text-decoration:line-through;
  color:#999;
}
.score-table tr.total{
  background:#eef6ff;
  font-weight:bold;
}
</style>
</head>

<body>

<header>ğŸ€„ éº»é›€ã‚¹ã‚³ã‚¢</header>

<main>
<table>
<tr><th>åå‰</th><th>ã‚¹ã‚³ã‚¢</th><th>ãƒˆãƒ“</th><th>æœ€çµ‚</th></tr>
<tr data-i="0" class="active"><td>A</td><td><input class="score" readonly></td><td><button class="tobi"></button></td><td class="final"></td></tr>
<tr data-i="1"><td>B</td><td><input class="score" readonly></td><td><button class="tobi"></button></td><td class="final"></td></tr>
<tr data-i="2"><td>C</td><td><input class="score" readonly></td><td><button class="tobi"></button></td><td class="final"></td></tr>
<tr data-i="3"><td>D</td><td><input class="score" readonly></td><td><button class="tobi"></button></td><td class="final"></td></tr>
</table>

<div class="actions">
  <button id="calc">è¨ˆç®—</button>
  <button id="reg" disabled>ç™»éŒ²</button>
  <button id="show">å±¥æ­´</button>
</div>

<div id="history"></div>
</main>

<div class="keypad">
<button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button><button data-k="up">â†‘</button>
<button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button><button data-k="down">â†“</button>
<button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button><button data-k="pm">Â±</button>
<button data-k="clear">C</button><button data-k="0">0</button><button data-k="close">Ã—</button>
</div>

<div id="loading"><div></div></div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycby1XFM-wXWJKnuSnLXpuUGhT6dE-bmrgFwVI_V5XVzLlHTnsFr0TiVRGRfNlqK38z_a/exec';

let cur = 0;
let lastScore = null;
let editing = [false,false,false,false];

function focus(i){
  cur = Math.max(0,Math.min(3,i));
  $('tr').removeClass('active');
  $(`tr[data-i="${cur}"]`).addClass('active');
  editing[cur] = false;
}

$('.score').on('click',function(){
  focus($(this).closest('tr').data('i'));
});

$('.keypad button').on('click',function(){
  const k=$(this).data('k');
  const inp=$('.score').eq(cur);

  if(!editing[cur] && ['0','1','2','3','4','5','6','7','8','9','pm'].includes(k)){
    inp.val('');
    editing[cur]=true;
  }

  if(k==='up') return focus(cur-1);
  if(k==='down') return focus(cur+1);
  if(k==='clear'){ inp.val(''); editing[cur]=false; return; }
  if(k==='pm'){
    const v=inp.val();
    if(!v) return;
    inp.val(v.startsWith('-')?v.slice(1):'-'+v);
    return;
  }
  if(k==='close'){ $('.keypad').addClass('hidden'); return; }
  inp.val((inp.val()||'')+k);
});

/* ãƒˆãƒ“ */
$('.tobi').on('click',function(){
  if($(this).text()===''){ $(this).text('+10').addClass('plus'); return; }
  if($(this).text()==='+10'){ $(this).text('-10').removeClass('plus').addClass('minus'); return; }
  $(this).text('').removeClass('minus');
});

/* è¨ˆç®— */
$('#calc').on('click',()=>{
  let raw=$('.score').map((i,e)=>{
    const v=$(e).val();
    return v===''?null:Number(v);
  }).get();

  const empty=raw.map((v,i)=>v===null?i:-1).filter(i=>i!==-1);
  if(empty.length>1){ alert('æœªå…¥åŠ›ã¯1äººã¾ã§'); return; }

  if(empty.length===1){
    const idx=empty[0];
    raw[idx]=1000-raw.filter(v=>v!==null).reduce((a,b)=>a+b,0);
    $('.score').eq(idx).val(raw[idx]);
  }

  if(raw.reduce((a,b)=>a+b,0)!==1000){
    alert('åˆè¨ˆã¯1000ã«ã—ã¦ãã ã•ã„'); return;
  }

  const plus=$('.tobi').filter((i,e)=>$(e).text()==='+10').length;
  const minus=$('.tobi').filter((i,e)=>$(e).text()==='-10').length;
  if(!((plus===0&&minus===0)||(plus===1&&minus===1))){
    alert('ãƒˆãƒ“è¨­å®šãŒä¸æ­£ã§ã™'); return;
  }

  const order=[0,1,2,3].sort((a,b)=>raw[b]-raw[a]);
  const uma=[500,100,-100,-300];
  let sc=raw.map((v,i)=>Math.round((v+uma[order.indexOf(i)]-300)/10));
  sc[order[0]]-=sc.reduce((a,b)=>a+b,0);

  $('.tobi').each((i,e)=>{
    if($(e).text()==='+10') sc[i]+=10;
    if($(e).text()==='-10') sc[i]-=10;
  });

  lastScore=sc;
  $('.final').each((i,e)=>{
    $(e).text(sc[i]).removeClass('plus minus')
      .addClass(sc[i]>=0?'plus':'minus');
  });
  $('#reg').prop('disabled',false);
});

/* ç™»éŒ² */
$('#reg').on('click',()=>{
  if(!confirm('ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ')) return;
  $('#loading').show();
  fetch(GAS_URL,{
    method:'POST',
    body:JSON.stringify({score:lastScore})
  })
  .then(r=>r.json())
  .then(renderHistory)
  .finally(()=>$('#loading').hide());
});

/* å±¥æ­´ */
$('#show').on('click',()=>{
  $('#loading').show();
  fetch(GAS_URL).then(r=>r.json()).then(renderHistory)
    .finally(()=>$('#loading').hide());
});

function renderHistory(data){
  let sum=[0,0,0,0];
  let html='<table class="score-table"><tr><th>No</th><th>æ—¥æ™‚</th><th>A</th><th>B</th><th>C</th><th>D</th></tr>';
  data.forEach(d=>{
    if(d.valid) d.score.forEach((v,i)=>sum[i]+=v);
    html+=`
      <tr class="${d.valid?'':'invalid'}" data-row="${d.row}">
        <td>${d.no}</td>
        <td>${new Date(d.time).toLocaleString()}</td>
        ${d.score.map(s=>`<td>${s}</td>`).join('')}
      </tr>`;
  });
  html+=`<tr class="total"><td colspan="2">åˆè¨ˆ</td>${sum.map(s=>`<td>${s}</td>`).join('')}</tr></table>`;
  $('#history').html(html);

  $('.score-table tr[data-row]').on('click',function(){
    if(confirm('æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã‹ï¼Ÿ')){
      fetch(GAS_URL+'?toggle='+$(this).data('row'))
        .then(r=>r.json())
        .then(renderHistory);
    }
  });
}
</script>

</body>
</html>
