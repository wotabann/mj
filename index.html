<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MAHJONG SCORE</title>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<style>
body{font-family:sans-serif;background:#f5f7f6;margin:0}
header{background:#0f4d3c;color:#fff;padding:12px;font-weight:bold}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
.pos{color:#2ecc71;font-weight:bold}
.neg{color:#e74c3c;font-weight:bold}
.focus{outline:3px solid #0f4d3c}
.btn{padding:10px;margin:4px;border-radius:20px;border:none}
.calc{background:#0f4d3c;color:#fff}
.reg{background:#caa44a;color:#fff}
.hist{background:#ccc}
#calcBox{position:fixed;bottom:0;right:0;width:70%;background:#eee;padding:10px}
.calcKey{width:23%;padding:15px;margin:1%;font-size:18px}
#toggleCalc{position:fixed;bottom:10px;left:10px;background:#0f4d3c;color:#fff;border-radius:50%;padding:15px}
#loading{display:none;position:fixed;top:0;left:0;right:0;bottom:0;
background:rgba(0,0,0,.4);color:#fff;font-size:30px;
align-items:center;justify-content:center}
.invalid{text-decoration:line-through;opacity:.5}
</style>
</head>

<body>

<header>MAHJONG SCORE</header>

<table>
<tr><th>名前</th><th>スコア</th><th>トビ</th><th>最終</th></tr>
<tr data-i="0"><td>A</td><td><input></td><td class="tobi"></td><td class="final"></td></tr>
<tr data-i="1"><td>B</td><td><input></td><td class="tobi"></td><td class="final"></td></tr>
<tr data-i="2"><td>C</td><td><input></td><td class="tobi"></td><td class="final"></td></tr>
<tr data-i="3"><td>D</td><td><input></td><td class="tobi"></td><td class="final"></td></tr>
</table>

<button class="btn calc">計算</button>
<button class="btn reg">登録</button>
<button class="btn hist">履歴</button>

<table id="history"></table>

<div id="calcBox"></div>
<button id="toggleCalc">×</button>

<div id="loading">ぐるぐる…</div>

<script>
const GAS_URL = '★★ここにGASのURL★★';

let focus = 0;
let clearNext = false;

$('input').on('focus',function(){
  $('input').removeClass('focus');
  $(this).addClass('focus');
  focus = $(this).closest('tr').data('i');
  clearNext = true;
});

function keypad(){
  const k = ['7','8','9','↑','4','5','6','↓','1','2','3','±','C','0','×'];
  $('#calcBox').html(k.map(v=>`<button class="calcKey">${v}</button>`));
}
keypad();

$(document).on('click','.calcKey',function(){
  let v = $(this).text();
  let $i = $('input').eq(focus);
  let val = $i.val();

  if(clearNext && !['↑','↓'].includes(v)){ val=''; clearNext=false; }

  if(v==='↑') focus=Math.max(0,focus-1);
  else if(v==='↓') focus=Math.min(3,focus+1);
  else if(v==='C') val='';
  else if(v==='±') val = val ? -Number(val) : '-';
  else if(v==='×'){ $('#calcBox').toggle(); $('#toggleCalc').text($('#calcBox').is(':visible')?'×':'電'); return;}
  else val += v;

  $('input').eq(focus).focus().val(val);
});

$('.calc').click(calcScore);

function calcScore(){
  let s = $('input').map((i,e)=>$(e).val()).get();
  let empty = s.filter(v=>v==='').length;
  if(empty>=2) return alert('空欄が多すぎます');

  if(empty===1){
    let sum = s.reduce((a,b)=>a+(b===''?0:Number(b)),0);
    $('input').eq(s.indexOf('')).val(1000-sum);
    s = $('input').map((i,e)=>$(e).val()).get();
  }

  if(s.reduce((a,b)=>a+Number(b),0)!=1000) return alert('合計が1000ではありません');

  let arr = s.map((v,i)=>({i, v:Number(v)})).sort((a,b)=>b.v-a.v);
  let base=[500,100,-100,-300];
  let tmp=[];
  arr.forEach((o,rank)=>{
    tmp[o.i]=(o.v+base[rank]-300)/10;
  });
  tmp[arr[0].i]=-(tmp.reduce((a,b)=>a+b,0)-tmp[arr[0].i]);

  tmp.forEach((v,i)=>{
    $('.final').eq(i).text(v).addClass(v>=0?'pos':'neg');
  });
}

$('.reg').click(()=>{
  if(!confirm('登録しますか？'))return;
  $('#loading').show();
  const f = $('.final').map((i,e)=>$(e).text()).get();
  $.getJSON(GAS_URL,{action:'add',a:f[0],b:f[1],c:f[2],d:f[3]})
   .done(drawHist).fail(()=>alert('異常')).always(()=>$('#loading').hide());
});

$('.hist').click(()=>{
  $('#loading').show();
  $.getJSON(GAS_URL,{action:'list'})
   .done(drawHist).fail(()=>alert('異常')).always(()=>$('#loading').hide());
});

function drawHist(res){
  let h='<tr><th>日時</th><th>A</th><th>B</th><th>C</th><th>D</th></tr>';
  res.data.forEach((r,i)=>{
    h+=`<tr data-row="${i+2}" class="${r[6]?'' :'invalid'}">
    <td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td></tr>`;
  });
  $('#history').html(h);
}

$('#history').on('click','tr',function(){
  if(!confirm('有効/無効を切り替えますか？'))return;
  $('#loading').show();
  $.getJSON(GAS_URL,{action:'toggle',row:$(this).data('row')})
   .done(drawHist).always(()=>$('#loading').hide());
});
</script>
</body>
</html>
