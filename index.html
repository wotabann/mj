<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>éº»é›€ã‚¹ã‚³ã‚¢ç®¡ç†</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
/* ===== ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ ===== */
:root{
  --green-dark:#0f3d2e;
  --green-base:#1f6f54;
  --green-light:#2f8f6a;
  --plus:#1b7f4b;
  --minus:#b00020;
}

/* ===== å…¨ä½“ ===== */
body{
  margin:0;
  padding:10px;
  padding-bottom:260px;
  font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
  background:var(--green-dark);
  color:#fff;
}
body.light{
  background:#e6f4ef;
  color:#0f3d2e;
}
h3{text-align:center;margin:8px 0;}

/* ===== å…¥åŠ›ãƒ†ãƒ¼ãƒ–ãƒ« ===== */
table{
  width:100%;
  border-collapse:collapse;
}
.input-table{
  background:#f5f6f4;
  color:#1a1a1a;
  border:2px solid var(--green-dark);
  border-radius:12px;
  overflow:hidden;
}
.input-table th{
  background:#e1e5e2;
  color:#0f3d2e;
  padding:8px;
}
.input-table td{
  padding:8px;
  border-bottom:1px solid #cfd6d2;
  text-align:center;
}
.input-table tr.active{
  background:#d9efe6;
}

/* åå‰ï¼‹ã‚«ãƒ¼ã‚½ãƒ« */
.cursor{opacity:0;margin-right:4px;color:#0f3d2e;}
tr.active .cursor{opacity:1;}
.name{font-weight:bold;}

/* å…¥åŠ›æ¬„ */
input.score{
  width:90px;
  font-size:20px;
  text-align:right;
  background:#fff;
  color:#000;
  border:none;
  border-radius:8px;
  padding:6px;
  box-shadow:inset 0 0 0 1px #aab5af;
}

/* ãƒˆãƒ“è³ */
.toggle{
  border:none;
  border-radius:8px;
  padding:6px 10px;
}
.toggle.plus{background:#c8f5d4;color:#0f3d2e;}
.toggle.minus{background:#ffd6d6;color:#6a0000;}

/* æœ€çµ‚ç‚¹ */
.final{font-size:18px;font-weight:bold;}
.final.plus{color:var(--plus);}
.final.minus{color:var(--minus);}

/* è¨ˆç®—ãƒãƒƒãƒ— */
@keyframes pop{
  0%{transform:scale(.9);opacity:.3}
  60%{transform:scale(1.15)}
  100%{transform:scale(1);opacity:1}
}
.final.pop{animation:pop .25s ease-out}

/* ãƒœã‚¿ãƒ³ */
button.main{
  width:48%;
  font-size:18px;
  padding:14px 0;
  border:none;
  border-radius:12px;
  background:linear-gradient(180deg,#3ba37a,#1f6f54);
  color:#fff;
}
button:disabled{opacity:.4}

/* ===== ãƒ†ãƒ³ã‚­ãƒ¼ï¼ˆå³å¯„ã›70%ï¼‰ ===== */
.keypad{
  position:fixed;
  bottom:0;
  right:0;
  width:70%;
  max-width:420px;
  background:#f5f6f4;
  border-top:2px solid var(--green-dark);
  border-left:2px solid var(--green-dark);
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
  padding:10px;
  box-shadow:-4px 0 10px rgba(0,0,0,.15);
}
.keypad button{
  font-size:20px;
  padding:16px 0;
  border:none;
  border-radius:12px;
  background:#fff;
  box-shadow:0 3px 0 #aab5af;
}
.keypad button:active{
  transform:translateY(2px);
  box-shadow:0 1px 0 #aab5af;
}
.keypad button[data-k="up"],
.keypad button[data-k="down"]{background:#e1e5e2;}
.keypad button[data-k="clear"]{
  grid-column:span 3;
  background:#ffd6d6;
  color:#6a0000;
}
</style>
</head>

<body>

<h3>
åŠè˜ <span id="round">1</span>
<button id="themeToggle" style="float:right;">ğŸŒ™</button>
</h3>

<table class="input-table">
<tr><th>åå‰</th><th>ã‚¹ã‚³ã‚¢</th><th>ãƒˆãƒ“è³</th><th>æœ€çµ‚</th></tr>

<tr data-idx="0">
<td><span class="cursor">â–¶ï¸</span><span class="name">A</span></td>
<td><input class="score" readonly></td>
<td><button class="toggle"></button></td>
<td class="final"></td>
</tr>

<tr data-idx="1">
<td><span class="cursor">â–¶ï¸</span><span class="name">B</span></td>
<td><input class="score" readonly></td>
<td><button class="toggle"></button></td>
<td class="final"></td>
</tr>

<tr data-idx="2">
<td><span class="cursor">â–¶ï¸</span><span class="name">C</span></td>
<td><input class="score" readonly></td>
<td><button class="toggle"></button></td>
<td class="final"></td>
</tr>

<tr data-idx="3">
<td><span class="cursor">â–¶ï¸</span><span class="name">D</span></td>
<td><input class="score" readonly></td>
<td><button class="toggle"></button></td>
<td class="final"></td>
</tr>
</table>

<div style="display:flex;justify-content:space-between;margin-top:10px;">
  <button id="calc" class="main">è¨ˆç®—</button>
  <button id="save" class="main" disabled>ç™»éŒ²</button>
</div>

<!-- ãƒ†ãƒ³ã‚­ãƒ¼ -->
<div class="keypad">
  <button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button><button data-k="up">â†‘</button>
  <button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button><button data-k="down">â†“</button>
  <button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button><button data-k="sign">Â±</button>
  <button data-k="0">0</button>
  <button data-k="clear">C</button>
</div>

<script>
const GAS_URL="â˜…â˜…â˜…GASã®URLâ˜…â˜…â˜…";
let cur=0,round=1,fresh=[true,true,true,true],lastRaw=[],lastScore=[];

/* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ */
function focus(i){
  cur=Math.max(0,Math.min(3,i));
  fresh[cur]=true;
  $('tr[data-idx]').removeClass('active').eq(cur).addClass('active');
}
focus(0);

/* ãƒˆãƒ“è³ãƒˆã‚°ãƒ« */
$('.toggle').on('click',function(){
  if($(this).hasClass('plus'))$(this).removeClass('plus').addClass('minus').text('-10');
  else if($(this).hasClass('minus'))$(this).removeClass('minus').text('');
  else $(this).addClass('plus').text('+10');
});

/* ãƒ†ãƒ³ã‚­ãƒ¼å…¥åŠ› */
$('.keypad button').on('click',function(){
  const k=$(this).data('k');
  const inp=$('tr[data-idx]').eq(cur).find('.score');
  let v=inp.val();

  if(k==='up')return focus(cur-1);
  if(k==='down')return focus(cur+1);

  if(fresh[cur]){inp.val('');v='';fresh[cur]=false;}

  if(k==='sign'&&v)inp.val(v.startsWith('-')?v.slice(1):'-'+v);
  if(/[0-9]/.test(k))inp.val(v+k);
  if(k==='clear'){inp.val('');fresh[cur]=true;}
});

/* äº”æ¨å…­å…¥ */
function r56(n){const i=Math.floor(n);return n-i<0.6?i:i+1;}

/* è¨ˆç®— */
$('#calc').on('click',()=>{
  let raw=[],bonus=[],empty=-1;

  $('tr[data-idx]').each(function(i){
    const v=$(this).find('.score').val();
    if(v===''){if(empty!==-1)return alert('æœªå…¥åŠ›ã¯1äººã¾ã§');empty=i;raw.push(null);}
    else raw.push(Number(v));
    const b=$(this).find('.toggle');
    bonus.push(b.hasClass('plus')?10:b.hasClass('minus')?-10:0);
  });

  if(empty!==-1){
    const s=raw.filter(v=>v!==null).reduce((a,b)=>a+b,0);
    raw[empty]=1000-s;
    $('tr[data-idx]').eq(empty).find('.score').val(raw[empty]);
  }

  if(bonus.filter(v=>v===10).length!==bonus.filter(v=>v===-10).length)
    return alert('ãƒˆãƒ“ã¨é£›ã°ã—ã¯ã‚»ãƒƒãƒˆ');

  const ord=raw.map((v,i)=>({v,i})).sort((a,b)=>b.v-a.v);
  let t=[...raw];
  t[ord[0].i]+=500;t[ord[1].i]+=100;t[ord[2].i]-=100;t[ord[3].i]-=300;

  let sc=t.map(v=>r56((v-300)/10));
  sc[ord[0].i]-=sc.reduce((a,b)=>a+b,0);
  sc=sc.map((v,i)=>v+bonus[i]);

  $('.final').each((i,e)=>{
    $(e).text(sc[i]).removeClass('plus minus pop')
      .addClass(sc[i]>=0?'plus':'minus')
      .addClass('pop');
  });

  lastRaw=raw;lastScore=sc;
  $('#save').prop('disabled',false);
});

/* ç™»éŒ² */
$('#save').on('click',()=>{
  fetch(GAS_URL,{method:'POST',body:JSON.stringify({round,raw:lastRaw,score:lastScore})})
  .then(()=>{round++;$('#round').text(round);reset();});
});

/* ãƒªã‚»ãƒƒãƒˆ */
function reset(){
  $('.score').val('');
  $('.toggle').removeClass('plus minus').text('');
  $('.final').text('');
  fresh=[true,true,true,true];
  focus(0);
  $('#save').prop('disabled',true);
}

/* ãƒ†ãƒ¼ãƒåˆ‡æ›¿ */
const t=localStorage.getItem('theme');
if(t==='light')$('body').addClass('light');
$('#themeToggle').on('click',()=>{
  $('body').toggleClass('light');
  localStorage.setItem('theme',$('body').hasClass('light')?'light':'dark');
});
</script>

</body>
</html>
