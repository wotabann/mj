<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>麻雀スコア管理</title>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  margin: 10px;
  background: #f4f6f5;
}

h2 {
  margin: 6px 0;
  color: #0f3d2e;
}

table {
  width: 100%;
  border-collapse: collapse;
}

.input-table {
  background: #f7f8f7;
  border: 2px solid #0f3d2e;
}

.input-table th {
  background: #e1e5e2;
  color: #0f3d2e;
  padding: 6px;
}

.input-table td {
  padding: 6px;
  text-align: center;
}

.input-table tr.active {
  background: #d9efe6;
}

.score {
  width: 60px;
  text-align: right;
  font-size: 18px;
  background: #fff;
  border: 1px solid #aaa;
}

.final.plus { color: green; }
.final.minus { color: red; }

.tobi {
  width: 50px;
  font-weight: bold;
  border-radius: 10px;
}

.tobi.plus { background:#c9f2d8; }
.tobi.minus { background:#f6caca; }

button {
  font-size: 16px;
  padding: 8px 14px;
  margin: 6px 4px;
}

.keypad {
  position: fixed;
  bottom: 0;
  right: 0;
  width: 70%;
  background: #f5f6f4;
  border-top: 2px solid #0f3d2e;
  border-left: 2px solid #0f3d2e;
  padding: 10px;
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
}

.keypad button {
  font-size: 20px;
  padding: 14px 0;
  background: #fff;
  border-radius: 10px;
}

.keypad .clear { background:#ffd6d6; }
.keypad .move { background:#e1e5e2; }

.score-table {
  width:100%;
  margin-top:10px;
  border-collapse:collapse;
  background:#fff;
}

.score-table th,
.score-table td {
  border:1px solid #c9d7e3;
  padding:6px;
  color:#222;
  text-align:center;
}

.score-table th {
  background:#f3f8fc;
}

.score-table tr.invalid {
  text-decoration: line-through;
  color:#999;
  background:#f5f5f5;
}

.score-table tr.total {
  font-weight:bold;
  background:#eef6ff;
}
</style>
</head>

<body>

<h2>入力</h2>

<table class="input-table">
<tr><th>名前</th><th>スコア</th><th>トビ賞</th><th>最終点</th></tr>

<tr data-idx="0" class="active">
<td>A</td>
<td><input class="score" readonly></td>
<td><button class="tobi"> </button></td>
<td class="final"></td>
</tr>
<tr data-idx="1">
<td>B</td>
<td><input class="score" readonly></td>
<td><button class="tobi"> </button></td>
<td class="final"></td>
</tr>
<tr data-idx="2">
<td>C</td>
<td><input class="score" readonly></td>
<td><button class="tobi"> </button></td>
<td class="final"></td>
</tr>
<tr data-idx="3">
<td>D</td>
<td><input class="score" readonly></td>
<td><button class="tobi"> </button></td>
<td class="final"></td>
</tr>
</table>

<button id="calc">計算</button>
<button id="reg" disabled>登録</button>
<button id="show">スコア表示</button>

<div id="scoreArea"></div>

<div class="keypad">
<button class="move" data-k="up">↑</button>
<button class="move" data-k="down">↓</button>
<button data-k="-">−</button>
<button data-k="clear" class="clear">C</button>

<button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button>
<button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button>
<button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button>
<button data-k="0">0</button>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycby1XFM-wXWJKnuSnLXpuUGhT6dE-bmrgFwVI_V5XVzLlHTnsFr0TiVRGRfNlqK38z_a/exec';

let cur = 0;
let fresh = [true,true,true,true];
let round = 1;
let lastScore = null;

// フォーカス
function focus(i){
  cur = Math.max(0,Math.min(3,i));
  fresh[cur] = true;
  $('tr[data-idx]').removeClass('active');
  $('tr[data-idx="'+cur+'"]').addClass('active');
}

// テンキー
$('.keypad button').on('click',function(){
  const k = $(this).data('k');
  const inp = $('.score').eq(cur);

  if(k==='up') return focus(cur-1);
  if(k==='down') return focus(cur+1);
  if(k==='clear'){ inp.val(''); fresh[cur]=true; return; }

  if(fresh[cur]){ inp.val(''); fresh[cur]=false; }
  inp.val((inp.val()||'') + k);
});

// トビ賞
$('.tobi').on('click',function(){
  const t = $(this).text().trim();
  $('.tobi').text('').removeClass('plus minus');

  if(t===''){
    $(this).text('+10').addClass('plus');
  } else if(t==='+10'){
    $(this).text('-10').addClass('minus');
  }
});

// 計算
$('#calc').on('click',function(){
  let raw = $('.score').map((i,e)=>Number($(e).val())||0).get();
  const filled = raw.filter(v=>v!==0).length;

  if(filled<3){
    alert('未入力は1人までです');
    return;
  }

  // 補完
  if(filled===3){
    const sum3 = raw.reduce((a,b)=>a+b,0);
    raw[raw.indexOf(0)] = 1000 - sum3;
    $('.score').eq(raw.indexOf(1000-sum3)).val(1000-sum3);
  }

  // 合計チェック
  const total = raw.reduce((a,b)=>a+b,0);
  if(total !== 1000){
    alert('合計は1000にしてください');
    return;
  }

  // 順位処理
  const idx = [0,1,2,3].sort((a,b)=>raw[b]-raw[a]);
  let pt = Array(4).fill(0);
  pt[idx[0]]+=500; pt[idx[1]]+=100; pt[idx[2]]-=100; pt[idx[3]]-=300;

  let sc = raw.map((v,i)=>Math.round(((v+pt[i]-300)/10)));

  const adj = sc.reduce((a,b)=>a+b,0);
  sc[idx[0]] -= adj;

  $('.tobi').each((i,e)=>{
    if($(e).text()==='+10') sc[i]+=10;
    if($(e).text()==='-10') sc[i]-=10;
  });

  lastScore = sc;
  $('.final').each((i,e)=>{
    $(e).text(sc[i]).removeClass('plus minus')
      .addClass(sc[i]>=0?'plus':'minus');
  });

  $('#reg').prop('disabled',false);
});

// 登録
$('#reg').on('click',function(){
  if(!confirm('登録しますか？')) return;

  fetch(GAS_URL,{
    method:'POST',
    body: JSON.stringify({ round, score:lastScore })
  }).then(()=>{
    alert('登録しました');
    round++;
    location.reload();
  });
});

// スコア表示
$('#show').on('click',loadScores);

function loadScores(){
  fetch(GAS_URL)
    .then(r=>r.json())
    .then(data=>{
      let sum=[0,0,0,0];
      let html='<table class="score-table"><tr><th>日時</th><th>A</th><th>B</th><th>C</th><th>D</th></tr>';
      data.forEach(d=>{
        if(d.valid){
          for(let i=0;i<4;i++) sum[i]+=d.score[i];
        }
        html+=`<tr class="${d.valid?'':'invalid'}" data-row="${d.row}">
          <td>${new Date(d.time).toLocaleString()}</td>
          ${d.score.map(s=>`<td>${s}</td>`).join('')}
        </tr>`;
      });
      html+=`<tr class="total"><td>合計</td>${sum.map(s=>`<td>${s}</td>`).join('')}</tr></table>`;
      $('#scoreArea').html(html);

      $('.score-table tr[data-row]').on('click',function(){
        const row=$(this).data('row');
        const invalid=$(this).hasClass('invalid');
        if(confirm(invalid?'有効に戻しますか？':'無効にしますか？')){
          fetch(GAS_URL+'?toggle='+row).then(loadScores);
        }
      });
    });
}
</script>

</body>
</html>
